#!/usr/bin/env bash

NODE_NAME=kubelet-exploit-worker
CONFIG_MAP_NAME=my-node-config

kubectl -n kube-system delete configmap ${CONFIG_MAP_NAME}
echo kubectl -n kube-system create configmap ${CONFIG_MAP_NAME} --from-file=kubelet=kubelet_configz_${NODE_NAME} -o yaml
kubectl -n kube-system create configmap ${CONFIG_MAP_NAME} --from-file=kubelet=kubelet_configz_${NODE_NAME} -o yaml

echo kubectl patch node ${NODE_NAME} -p "{\"spec\":{\"configSource\":{\"configMap\":{\"name\":\"${CONFIG_MAP_NAME}\",\"namespace\":\"kube-system\",\"kubeletConfigKey\":\"kubelet\"}}}}"
kubectl patch node ${NODE_NAME} -p "{\"spec\":{\"configSource\":{\"configMap\":{\"name\":\"${CONFIG_MAP_NAME}\",\"namespace\":\"kube-system\",\"kubeletConfigKey\":\"kubelet\"}}}}"

echo kubectl edit node kubelet-exploit-worker
